ifndef::imagesdir[:imagesdir: ../images]
[.text-justify]
== Domain Analysis and Modeling (30 pages)

[quote,Alberto Brandolini]
The amount of energy necessary to refute bullshit is an order of magnitude bigger than to produce it.

As we saw in the previous chapter, misinterpreted requirements cause a significant portion of software projects to fail.
Arriving at a shared understanding and creating a useful domain model, necessitates high degrees of collaboration with domain experts.
In this chapter, we will introduce the sample application we will use throughout the book and explore modeling techniques such as domain storytelling and event storming to enhance our collective understanding of the problem in a reliable and structured manner.

Originally conceived by Alberto Brandolini, EventStorming has emerged as a flexible and convenient format for the collaborative exploration of complex domains.
In this chapter, we will introduce the sample application used throughout the book and use the different flavors of EventStorming to arrive at a shared understanding of the problem and brainstorm ideas to arrive at a solution.

=== Introducing the LC Application

In many countries, international trade represents a significant portion of the gross domestic product (GDP) -- making an exchange of capital, goods, and services between untrusted parties spread across the globe a necessity.
While economic organizations such as the World Trade Organization (WTO) were formed specifically to ease and facilitate this process, differences in factors such as economic policy, trade laws, currency, etc. ensure that carrying out trade internationally can be a complex process with several entities involved across countries.
Letter of Credit exist to simplify this process.
Let's take a look at how they work.

==== What is Letter of Credit (LCs)?

Documentary Letter of Credit (LC) is a financial instrument issued by the banks as a contract between the importer (or buyer) and the exporter (or seller).
This contract specifies terms and conditions of the transaction under which importer promises to pay the exporter in exchange for the goods or services provided by the exporter.
Letter of Credit transaction typically involves multiple parties.
A simplified summary of the parties involved is described below:

1. *Importer*: The buyer of the goods or services.
2. *Exporter*: The seller of the goods or services.
3. *Freight Forwarder*: The agency that handles shipment of goods on behalf of the exporter.
This is only applicable in cases there is an exchange of physical goods.
4. *Issuing Bank*: The bank that the importer requests to issue the LC application.
Usually the importer has a pre-existing relationship with this bank.
5. *Advising Bank*: The bank that informs the exporter about the issuance of the LC. This is usually a bank that is native to the exporter's country.
6. *Negotiating Bank*: The bank that the exporter submits documents for the shipment of goods, or the services provided.
Usually the exporter has a pre-existing relationship with this bank.
7. *Reimbursement Bank*: The bank that reimburses the funds to the negotiating bank, at the request of the issuing bank.

NOTE: It is important to note that the same bank can play more than one role for a given transaction.
In the most complex cases, there can be four distinct banks involved for a transaction (sometimes even more, but we will skip those cases for brevity).

==== The Issuing Bank LC Application

XYZ Bank has reached out to us in order to automate the process of LC application and issuance.
In this chapter, and indeed the rest of this book, we will strive to understand, evolve, design and build a software solution to automate this process.

=== Enhancing Shared Understanding

When working with a problem where domain concepts are unclear, there is a need to arrive at a common understanding among key team members (both those that have bright ideas -- the business/product people, and those that translate those ideas into working software -- the software developers).
For this process to be effective, we tend to look for approaches that are:

* Quick, informal and effective
* Collaborative - Easy to learn and adopt for both non-technical and technical team members
* Pictorial - because a picture can be worth a thousand words
* Usable for both coarse grained and fine-grained scenarios

There are several means to arrive at this shared understanding.
Some commonly used approaches are listed below :

* UML
* BPMN
* Use Cases
* User Story Mapping
* CRC Models
* Data Flow Diagrams

Above modelling techniques have tried to formalize knowledge and express them in form of a structure diagram or text to help in delivering the business requirements as a software product.
However, this attempt has not narrowed but has widened the gap between the business and, the software systems.

We will use *domain storytelling* and *event storming* as our means to capture business knowledge from domain experts for consumption of Developers, Business Analysts etc.

=== Domain Storytelling

[quote,Margaret Atwood]
You’re never going to kill storytelling because it’s built into the human plan. We come with it.

==== Introducing Domain Storytelling

Scientific research has now proven that learning methods that employ audio-visual aids assist both the teacher and the learners in retaining and internalizing concepts very effectively. In addition, teaching what one has learnt to someone else helps reinforce ideas and also stimulates the formation of new ones. Domain storytelling is a collaborative modeling technique that combines a pictorial language, and a workshop format to serve as a very simple, quick and effective technique for sharing knowledge among team members.

NOTE: Attribution to original inventors

The pictorial notation of the technique is illustrated in the diagram below:

.Domain storytelling summarized
image::dst-summary.png[]

A domain story is conveyed using the following attributes:

*Actors* - Stories are communicated from the perspective of an actor (noun), for example, the issuing bank, who plays an active role in the context of that particular story. It is a good practice to use the ubiquitous language for the particular domain.

*Work Objects* - Actors act on some object, for example, applying for an LC. Again, this would be a term (noun) commonly used in the domain.

*Activities* - Actions (verb) performed by the actor on a work object. Represented by a labelled arrow connecting the actor and the work object.

*Annotations* - Used to capture additional information as part of the story, usually represented in few sentences.

*Sequence Numbers* - Usually, stories are told one sentence after the other. Sequence numbers helps capture the sequence of the activities in a story.

*Groups* - TODO

==== Using DST for the LC application
XYZ Bank has a process that allows processing of LCs. However, this process is very archaic, paper-based and manually intensive. Very few at the bank fully understand the process end-to-end and natural attrition has meant that the process is overly complex without good reason. So they are looking to digitize and simplify this process. We will employ a DST workshop to capture the current business flow. The following is an excerpt of a conversation between *Katie*, __the domain expert__ and *Patrick*, __the software developer__.


*Patrick* : _"Can you give me a high level overview of a typical LC Flow?"_ +
*Katie* : _"Sure, it all begins with the importer and the exporter entering into a contract for purchase of goods or services."_ +
*Patrick* : _"What form does this contract take? Is it a formal document? Or is this just a conversation?"_ +
*Katie* : _"This is just a conversation."_ +
*Patrick* : _"Oh okay. What does the conversation cover?"_ +
*Katie* : _Several things -- nature and quantity of goods, pricing details, payment terms, shipment costs and timelines, insurance, warranty, etc. These details may be captured in a purchase order -- which is a simple document elaborating the above._ +

image::domain-story-telling/lc-issue-step01.png[]

*Patrick* : _"Seems straight forward, so where does the bank come into the picture?"_ +
*Katie* : _"This is international trade and both the importer and the exporter need to mitigate the financial risk involved in such business transactions. So they involve a bank as a trusted mediator."_ +
*Patrick* : _"What kind of bank is this?"_ +
*Katie* : "_Usually, there are multiple banks involved. But it all starts with an *issuing bank*._" +
*Patrick* : _"What is an issuing bank?"_ +
*Katie* : _"Any bank that is authorized to mediate international trade deals. This has to be a bank in the importer's country."_ +
*Patrick* : _"Does the importer need to have an existing relationship with this bank?"_ +
*Katie* : _"Not necessarily. There may be other banks with whom the importer may have a relationship with -- which in turn liaises with the issuing bank on the importer's behalf. But to keep it simple, let's assume that the importer has an existing relationship with the issuing bank -- which is our bank in this case."_ +
*Patrick* : _"Does the importer provide details of the purchase order to the issuing bank to get started?"_ +
*Katie* : _"Yes. The importer provides the details of the transaction by making an *LC application*."_ +

image::domain-story-telling/lc-issue-step02.png[]

*Patrick* : _"What does the issuing bank do when they receive this LC application?"_ +
*Katie* : _"Mainly two things -- whet the financial standing of the importer and the legality of the goods being imported."_ +
*Patrick* : "Okay. What happens if everything checks out?" +
*Katie* : _"The issuing bank approves the LC and notifies the importer."_ +

image::domain-story-telling/lc-issue--step03.png[]

*Patrick* : _"What happens next? Does the issuing bank contact the exporter now?"_ +
*Katie* : _"Not yet. It is not that simple. The issuing bank can only deal with a counterpart bank in the exporter's country. This bank is called the *advising bank*."_ +

image::domain-story-telling/lc-issue-step04.png[]

*Patrick* : _"What does the advising bank do?"_ +
*Katie* : _"The advising bank notifies the exporter about the LC."_ +
*Patrick* : _"Doesn't the importer need to know that the LC has been advised?"_ +
*Katie* : _"Yes. The issuing bank notifies the importer that the LC has been advised to the exporter."_ +

image::domain-story-telling/lc-issue-step05.png[]

*Patrick* : _"How does the exporter know how to proceed?"_ +
*Katie* : _"Through the advising bank -- they notify the exporter that the LC was issued."_ +

image::domain-story-telling/lc-issue-step06.png[]

*Patrick* : _"Does the exporter initiate shipping at this time and how do they get paid?"_ +
*Katie* : _"Through the advising bank -- they notify the exporter that the LC was issued and this triggers the next steps in the process -- which is called *settlement*. But let's focus on issuance right now. We will discuss settlement at a later time."_ +

=== Event Storming
In the previous section, we gained a high level understanding of the LC Issuance process. To be able to build a real-world application, it will help to use a method that delves into the next level of detail. Event storming, originally conceived by Alberto Brandolini, is one such method.

In this method, one simply starts by listing out all the events that are significant to the business domain in roughly chronological order on a wall or whiteboard using a bunch of colored sticky notes. Each of the note types (denoted by a color) serve a specific purpose as outlined below:

* *Domain Event*: An event that is significant to the business process -- expressed in past tense.

* *Command*: An action, or an activity that may result in one or more domain events occurring. This is either user initiated or system initiated, in response to a domain event.

* *Users*: A person who performs a business action/activity.

* *Policies*: A set of business rules that need to be adhered to, for an action/activity to be successfully performed.

* *Read Models*: A piece of information required to perform an action/activity.

* *External Systems*: A system significant to the business process, but out of scope in the current context.

* *Hotspots*: Points of contention within the system that are likely confusing and/or puzzling beyond a small subsection of the team.

NOTE: *Why Domain Events*? When trying to understand a business process, it is convenient to express significant facts or things that happen in that context. It can also be informal and easy for audiences that are uninitiated with this practice.

==== Using Event Storming for the LC Application

===== Phase 1: Event Chronology
Recall significant domain events that happen in the system and paste them on the whiteboard, using Orange post-its as depicted below. Ensure that the event stickies are pasted roughly in the chronological order of occurrence.  As the timeline is enforced, the business flow begins to emerge.

.To be updated
image::event-storming/01-events.png[]

This acts as an aid to understand the big picture.  This also enables people in the room to identify hotspots in the existing business process.  In the above illustration, we realized that, the process to handle "declined LC applications" is sub-optimal, that is applicant does not receive any information when their application is declined.

To address this, we added a new domain event which explicitly indicates that an application is declined, as depicted below.

.To be updated
image::event-storming/01-events.png[]

===== Phase 2: Identify triggering activities and external systems
Having arrived at a high level understanding of event chronology, the next step is to embellish the visual with activities/a that cause these events to occur (using blue stickies) and interactions with external systems (using ??? stickies) as depicted in the diagram below:

.To be updated
image::event-storming/02-activities-and-external-systems.png[]

===== Phase 3: Capture users, context and policies
The next step is to capture *users* who perform these activities along with their functional *context* (using yellow stickies) and policies (using purple stickies) as depicted in the diagram below.

image::event-storming/03-users-and-policies.png[]

===== Phase 4: Read models
image::event-storming/04-read-models.png[]

===== Phase 5: Grouping Commands and Events into Aggregates
